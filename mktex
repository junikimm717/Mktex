#!/bin/sh

TEMPLATE_DIR="$(dirname "$(realpath "$0")")"
# default template
TEMPLATE=std
# 
DOCKER_IMAGE=junikimm717/mktex-build

# function to generate templates.
gen_template() {
    if test -e "$1"; then
      echo "$1 already exists.";
      exit 1;
    fi
    cp -r "$TEMPLATE_DIR"/templates/"$TEMPLATE" "$1"
    cd "$1" || exit
    for FILE in template.*; do
      NEW="$(echo "$FILE" | sed "s/template/$1/")"
      mv "$FILE" "$NEW"
    done
    for F in * .*; do
        if [ -d "$F" ]; then
            continue
        fi
        sed "s/template/$1/g" "$F" > "$F.tmp"
        mv "$F.tmp" "$F"
    done
    cd ..
}

get_manual() {
    cat "$TEMPLATE_DIR"/manual/main.txt
}

if [ $# -eq 0 ]; then
    get_manual
    exit 0
fi

case "$1" in
  pull)
    if ! type docker > /dev/null; then
      echo "docker does not exist on your system."
      exit 127
    fi
    docker pull "$DOCKER_IMAGE"
    exit
  ;;
  build)
    if ! type docker > /dev/null; then
      echo "docker does not exist on your system."
      exit 127
    fi
    if ! docker image ls | grep -E "$DOCKER_IMAGE" > /dev/null; then
      echo "The build image does not locally exist. Run \`mktex pull\` to install it."
      exit 127
    fi
    docker run -u "$(id -u):$(id -g)" -v  "$(pwd)":/files --rm "$DOCKER_IMAGE"
    exit
  ;;
  lstemplates|l)
    cd "$TEMPLATE_DIR/templates" || (echo "$TEMPLATE_DIR/templates does not exist"; exit 1;)
    echo *;
    exit
  ;;
  -h|--help)
    get_manual
    exit
  ;;
  create|c)
    shift;
  ;;

  *)
    echo "Invalid verb $1."
    exit 127;
  ;;
esac

while test $# -gt 0; do
    case "$1" in 
        -t|--template)
          shift;
          if [ -z "$1" ]; then
            echo "Empty template name."
            exit 1;
          elif ! test -d  "$TEMPLATE_DIR"/templates/"$1"; then
            echo "Template $1 does not exist."
            exit 1;
          fi
          TEMPLATE="$1"
          shift;
        ;;
        -h|--help)
            cat "$TEMPLATE_DIR"/manual/create.txt
            exit
        ;;
        -*)
            echo "Invalid option $1"
            exit 1
        ;;
        *)
            echo "generating $1 from template $TEMPLATE"
            gen_template "$1"
            shift;
        ;;
    esac
done
